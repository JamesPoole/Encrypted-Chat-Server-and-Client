<!DOCTYPE html>
<html lang="en">
<html>

<head>
	<!--Import Google Icon Font-->
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<!--Import materialize.css-->
	<link type="text/css" rel="stylesheet" href="/materialize/css/materialize.min.css" media="screen,projection" />
	<!--Let browser know website is optimized for mobile-->
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<meta name="msapplication-TileColor" content="#da532c">
	<meta name="theme-color" content="#ffffff">
	<title>EncrypChat</title>
	<style>
		/* label underline focus color */

		.row .input-field input:focus {
			border-bottom: 1px solid purple !important;
			box-shadow: 0 1px 0 0 purple !important
		}

		.switch label input[type=checkbox]:checked+.lever {
			background-color: #ce93d8;
		}

		.switch label input[type=checkbox]:checked+.lever:after {
			background-color: #ab47bc;
		}
	</style>
</head>

<body>
	<nav class="purple lighten-1" role="navigation">
		<div class="nav-wrapper row" style="margin-left:5px"><a id="logo-container" href="#" class="brand-logo">EncrypChat</a>
			<a href="#" data-target="nav-mobile" class="sidenav-trigger"><i class="material-icons">menu</i></a>
		</div>
	</nav>
	<div class="row">
		<div class="col s10" style="margin-top:10px">
			<h6 style="margin-left:5px"> Messages </h6>
		</div>
		<div class="switch col s2" style="margin-top:15px">
			<label>
				<input type="checkbox" id="encryptChat">
				<span class="lever"></span>
				Encrypt Chat
			</label>
		</div>
	</div>
	<div class="divider"></div>
	<div class="section">
		<div class="chat">
			<div id="messages" style="margin-left:5px; overflow:auto; height:400px">
			</div>
		</div>
	</div>
	<div class="divider"></div>

	<form action="" id="chatBox">
		<div class="row" style="position: fixed; bottom: 0; width: 100%;">
			<div class="input-field col s2">
				<input placeholder="Nickname" id="nick" type="text" class="validate">
			</div>
			<div class="input-field col s8" style=" display:flex;">
				<input placeholder="Write a message..." id="m" type="text" class="validate">
			</div>
			<div class="col s1">
				<button class="btn-floating btn-large waves-effect waves-light purple" style="margin-top:5px" type="submit" name="action">
					<i class="material-icons">send</i>
				</button>
			</div>
			<div class="col s1">
				<input type='file' id="files" hidden/>
				<button class="btn-floating btn-large waves-effect waves-light purple" id="upload" style="margin-top:5px">
						<i class="material-icons">attach_file</i>
				</button>
			</div>
		</div>
	</form>


	<script type="text/javascript" src="materialize/js/materialize.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script src="https://code.jquery.com/jquery-1.11.1.js"></script>
	<script type="text/javascript" src="/js/EncrypChat.js"></script>
	<script>
		$(document).ready(function() {
			$("a.submit").click(function() {
				document.getElementById("chatBox").submit();
			});
		});
	</script>
	<script>
		$("#upload").click(function(e) {
			// Stop upload button from being a submit button
			e.preventDefault();
			// Start upload file gui
			$("#files").click();
		});
	</script>
	<script>
		$(function() {
			var socket = io();
			var input = $('#files')[0], fileData;
			// print not encrypted
			socket.on('normalMessage', function(msg) {
				if ($('#encryptChat').is(":checked") == true) {
					$('#encryptChat').click(); // ensure the encrypted button is in sync
				}
				$('#messages').append($('<p>').text(msg));
				$("#messages").scrollTop($("#messages")[0].scrollHeight);
			});

			// print Encrypted Message
			socket.on('encryptedMessage', function(msg) {
				if ($('#encryptChat').is(":checked") == false) {
					$('#encryptChat').click(); // ensure the encrypted button is in sync
				}
				$('#messages').append($('<li>').text('SECURE -> ' + msg));
			});

			// Get message and decide if it should be encrypted or not
			$('#chatBox').submit(function() {
				if ($('#encryptChat').is(":checked")) {
					socket.emit('encryptProtocol', "Start chat encryption");
					socket.emit('encryptedMessage', $('#nick').val() + " - " + $('#m').val());
				} else {
					socket.emit('normalMessage', $('#nick').val() + " - " + $('#m').val());
				}
				$('#m').val('');
				return false;
			});

			// Get file that was sent
			socket.on('file', function(msg) {
				// placeholder!! currently just notifies of file upload
				// deal with file data here
				$('#messages').append($('<p>').text(msg));
				$("#messages").scrollTop($("#messages")[0].scrollHeight);
			});
			// Eventhandler for file input.
			function openfile(evt) {
				var files = input.files;
				// Pass the file to the blob, not the input[0].
				fileData = new Blob([files[0]]);
				// Pass getBuffer to promise.
				var promise = new Promise(getBuffer);
				// Wait for promise to be resolved, or log error.
				promise.then(function(data) {
					// Send base64 encoded data of byte array of image through socket io
					var b64encoded = btoa(String.fromCharCode.apply(null, data));
					socket.emit('file', b64encoded);
				}).catch(function(err) {
					console.log('Error: ', err);
				});
			}
			/*
			  Create a function which will be passed to the promise
			  and resolve it when FileReader has finished loading the file.
			*/
			function getBuffer(resolve) {
				var reader = new FileReader();
				reader.readAsArrayBuffer(fileData);
				reader.onload = function() {
					var arrayBuffer = reader.result
					var bytes = new Uint8Array(arrayBuffer);
					resolve(bytes);
				}
			}
			// Eventlistener for file input.
			input.addEventListener('change', openfile, false);


			// protocol

			// Get public and private keys
			socket.on('startRSA', function(msg) {
				generateRSA().then((key) => {
					rsaPublicKey = key.publicKey;
					rsaPrivateKey = key.privateKey;
					// export the public key and send it
					exportRSA(rsaPublicKey).then((key) => {
						var rsaExportedKey = key;
						socket.emit('sendPublicKey', rsaExportedKey);
					});
				});
			});

			// get sent key from other user and import it
			socket.on('receivePublicKey', function(msg) {
				var rsaExportedKey_2 = msg;
				importRSA_OAEP(rsaExportedKey_2).then((key) => {
					rsaPublicKey_2 = key;
					// $('#messages').append($('<li>').text('Other Users Public key -> ' + rsaPublicKey_2));
					// console.log(rsaPublicKey_2);
				});
			});

			// First step
			socket.on('step1', function(msg) {
				var ch1 = window.crypto.getRandomValues(new Uint8Array(6)); // random number challenge
				hashSHA(ch1).then((hashed) => { // H(ch1) hashed challenge
					signRSA(rsaPrivateKey, hashed).then((signedHash) => { // { H(ch1) }ka-1 signed hash with my private key
						var message = ch1 + "," + signedHash;
						encryptRSA(rsaPublicKey_2, message).then((data) => { // { ch1,{ H(ch1) }ka-1 }kb
							var message = "A,B," + data; // A,B,{ ch1,{ H(ch1) }ka-1 }kb
							socket.emit('getResponseStep2', message);
						});
					});
				});
			});

			// Step 2
			socket.on('step1', function(msg) {
				// Step 2
			});

		});
	</script>
</body>

</html>
