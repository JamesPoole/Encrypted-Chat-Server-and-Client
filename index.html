<!DOCTYPE html>
<html lang="en">
<html>

<head>
	<!--Import Google Icon Font-->
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<!--Import materialize.css-->
	<link type="text/css" rel="stylesheet" href="/materialize/css/materialize.min.css" media="screen,projection" />
	<link type="text/css" rel="stylesheet" href="/css/chatbubble.css" media="screen,projection" />
	<!--Let browser know website is optimized for mobile-->
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<meta name="msapplication-TileColor" content="#da532c">
	<meta name="theme-color" content="#ffffff">
	<title>EncrypChat</title>
	<style>
		/* label underline focus color */

		.row .input-field input:focus {
			border-bottom: 1px solid purple !important;
			box-shadow: 0 1px 0 0 purple !important
		}

		.switch label input[type=checkbox]:checked+.lever {
			background-color: #ce93d8;
		}

		.switch label input[type=checkbox]:checked+.lever:after {
			background-color: #ab47bc;
		}

		.clear {
			clear: both;
		}

		.removemargin {
			margin-top: -10px;
		}
	</style>
</head>

<body>
	<nav class="purple lighten-1" role="navigation">
		<div class="nav-wrapper row" style="margin-left:5px"><a id="logo-container" href="#" class="brand-logo">EncrypChat</a>
		</div>
	</nav>
	<div class="row">
		<div class="col s10" style="margin-top:10px">
			<h6 style="margin-left:5px"> Messages </h6>
		</div>
		<div class="switch col s2" style="margin-top:15px">
			<label>
				<input type="checkbox" id="encryptChat">
				<span class="lever"></span>
				Encrypt Chat
			</label>
		</div>
	</div>
	<div class="section">
		<div class="chat">
			<div id="messages" style="overflow:auto; height:75vh; padding-top:30px; margin-left:5px; margin-right:5px">
				<!--<img id="image" style="width: 300px; " />-->
			</div>
		</div>
	</div>
	<form action="" id="chatBox">
		<div class="row" style="position: fixed; bottom: 0; width: 100%;">
			<div class="input-field col s2">
				<input placeholder="Nickname" id="nick" type="text" class="validate">
			</div>
			<div class="input-field col s9" style=" display:flex;">
				<input placeholder="Write a message..." id="m" type="text" class="validate">
			</div>
			<div class="col s1">
				<button class="btn-floating btn-large waves-effect waves-light purple" style="margin-top:5px" type="submit" name="action">
					<i class="material-icons">send</i>
				</button>
				<input type='file' id="files" hidden/>
				<button class="btn-floating btn-large waves-effect waves-light purple" id="upload" style="margin-top:5px">
						<i class="material-icons">attach_file</i>
				</button>
			</div>
		</div>
	</form>


	<script type="text/javascript" src="materialize/js/materialize.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script src="socket.io-file-client.js"></script>
	<script type="text/javascript" src="/js/jquery-1.11.1.js"></script>
	<script type="text/javascript" src="/js/EncrypChat.js"></script>
	<script>
		$(document).ready(function() {
			$("a.submit").click(function() {
				document.getElementById("chatBox").submit();
			});
		});
	</script>
	<script>
		$("#upload").click(function(e) {
			// Stop upload button from being a submit button
			e.preventDefault();
			// Start upload file gui
			$("#files").click();
		});
	</script>
	<script>
		$(function() {
			var socket = io();
			var uploader = new SocketIOFileClient(socket);
			var input = $('#files')[0],
				fileData;

			// Here for debugging
			uploader.on('start', function(fileInfo) {
				// console.log('Start uploading', fileInfo);
			});
			uploader.on('stream', function(fileInfo) {
				// console.log('Streaming... sent ' + fileInfo.sent + ' bytes.');
			});
			uploader.on('complete', function(fileInfo) {
				// console.log('Upload Complete', fileInfo);
			});
			uploader.on('error', function(err) {
				// console.log('Error!', err);
			});
			uploader.on('abort', function(fileInfo) {
				// console.log('Aborted: ', fileInfo);
			});

			// print not encrypted
			socket.on('normalMessage', function(msg) {
				if ($('#encryptChat').is(":checked") == true) {
					$('#encryptChat').click(); // ensure the encrypted button is in sync
				}
				var append_string = "";
				var incoming_nickname = msg.substr(0, msg.indexOf('-'));
				var first_letter_nickname = msg.charAt(0);
				var current_nickname = $('#nick').val();
				msg = msg.split('-')[1];

				if (incoming_nickname == current_nickname) {
					append_string = '<div style="float:right;"><div class="removemargin talk-bubble tri-right right-top"><div class="talktext"><p>' + msg + '</p></div></div><div class="circle">' + first_letter_nickname + '</div></div><div class="clear"></div>'
				} else {
					append_string = '<div class="circle">' + first_letter_nickname + '</div><div class="removemargin talk-bubble tri-right left-top"><div class="talktext"><p>' + msg + '</p></div></div><div class="clear"></div>'
				}
				$('#messages').append($(append_string));
				$("#messages").scrollTop($("#messages")[0].scrollHeight);
			});

			// print Encrypted Message
			socket.on('encryptedMessage', function(msg) {
				var dec = new TextDecoder();
				if ($('#encryptChat').is(":checked") == false) {
					$('#encryptChat').click(); // ensure the encrypted button is in sync
				}
				if (msg != null) { // Decrypt the encrypted message
					msg = new Uint8Array(Object.values(msg));
					console.log("Message before decrypting:");
					console.log(msg);
					decryptAES(aesKab, iv, msg).then((message) => {
						message = dec.decode(message);

						var append_string = "";
						var incoming_nickname = message.substr(0, message.indexOf('-'));
						var first_letter_nickname = message.charAt(0);
						var current_nickname = $('#nick').val();
						message = message.split('-')[1];

						if (incoming_nickname === current_nickname) {
							append_string = '<div style="float:right;"><div class="removemargin talk-bubble tri-right right-top"><div class="talktext"><p>SECURE -> ' + message + '</p></div></div><div class="circle">' + first_letter_nickname +
								'</div></div><div class="clear"></div>'
						} else {
							append_string = '<div class="circle">' + first_letter_nickname + '</div><div class="removemargin talk-bubble tri-right left-top"><div class="talktext"><p>SECURE -> ' + message + '</p></div></div><div class="clear"></div>'
						}

						$('#messages').append($(append_string));
						$("#messages").scrollTop($("#messages")[0].scrollHeight);

					});
				} else { // Encryption started o tell the user
					message = "Other User turned on Encrption";
					var first_letter_nickname = "Sys";
					append_string = '<div class="circle">' + first_letter_nickname + '</div><div class="removemargin talk-bubble tri-right left-top"><div class="talktext"><p>SECURE -> ' + message + '</p></div></div><div class="clear"></div>'
					$('#messages').append($(append_string));
					$("#messages").scrollTop($("#messages")[0].scrollHeight);
				}
			});

			// Get message and decide if it should be encrypted or not
			$('#chatBox').submit(function() {
				if ($('#encryptChat').is(":checked")) {
					// console.log(aesKab);
					if (aesKab == null) {
						socket.emit('encryptProtocol', "Start chat encryption");
					} else {
						var enc = new TextEncoder("utf-8");
						var message = $('#nick').val() + "-" + $('#m').val();
						message = enc.encode(message);
						encryptAES(aesKab, iv, message).then((encryptedMsg) => {
							console.log("Encrypted Message Data");
							console.log(encryptedMsg);
							socket.emit('encryptedMessage', encryptedMsg);
						});
					}

				} else {
					socket.emit('normalMessage', $('#nick').val() + "-" + $('#m').val());
				}
				$('#m').val('');
				return false;
			});

			// Get file url that was sent
			socket.on('file', function(msg) {
				// console.log(msg);
				var append_string = "";
				var file_message = "";
				var incoming_nickname = msg.substr(0, msg.indexOf('$'));
				var first_letter_nickname = msg.charAt(0);
				var current_nickname = $('#nick').val();
				msg = msg.split('$')[1];
				file_message = msg.substring(0, 16) + "...";
				// console.log(msg)

				if (incoming_nickname == current_nickname) {
					append_string = '<div style="float:right;"><div class="removemargin talk-bubble tri-right right-top"><div class="talktext"><p><a href="' + document.URL + 'download/' + msg + '">' + file_message + '</a></p></div></div><div class="circle">' +
						first_letter_nickname + '</div></div><div class="clear"></div>'
				} else {
					append_string = '<div class="circle">' + first_letter_nickname + '</div><div class="removemargin talk-bubble tri-right left-top"><div class="talktext"><p><a href="' + document.URL + 'download/' + msg + '">' + file_message +
						'</a></p></div></div><div class="clear"></div>'
				}
				//display_message = '<p><a href="' + document.URL +'download/' + msg + '">' + msg +'</a></p>'
				$('#messages').append(append_string);
				$("#messages").scrollTop($("#messages")[0].scrollHeight);

			});

			// Eventhandler for file input.
			function openfile(evt) {
				var files = input.files;
				var nickname = $('#nick').val();
				var fileReader = new FileReader();
				fileReader.readAsDataURL(files[0]);
				fileReader.onload = function(e) {
					var uploadIds = uploader.upload(files, {
						data: nickname
					});
				}
			}
			// Eventlistener for file input.
			input.addEventListener('change', openfile, false);

			// Get public and private keys
			socket.on('startRSA', function(msg) {
				generateRSA().then((key) => {
					rsaPublicKey = key.publicKey;
					rsaPrivateKey = key.privateKey;
					// export the public key and send it
					exportRSA(rsaPublicKey).then((key) => {
						var rsaExportedKey = key;
						socket.emit('sendPublicKey', rsaExportedKey);
					});
				});
			});

			// get sent key from other user and import it
			socket.on('receivePublicKey', function(msg) {
				var rsaExportedKey_2 = msg;
				importRSA_OAEP(rsaExportedKey_2).then((key) => {
					rsaPublicKey_2 = key;
					// $('#messages').append($('<li>').text('Other Users Public key -> ' + rsaPublicKey_2));
					// console.log(rsaPublicKey_2);
				});
			});

			// Step 1: A
			socket.on('step1', function(msg) {
				passA = window.crypto.getRandomValues(new Uint8Array(6)); // random number challenge
				hashSHA(passA).then((hashed) => { // H(passA) hashed challenge
					signRSA(rsaPrivateKey, hashed).then((signedHash) => { // { H(passA) }ka-1 signed hash with my private key
						var combinedArray = new Uint8Array(passA.length + signedHash.length);
						combinedArray.set(passA);
						combinedArray.set(signedHash, passA.length);
						var splitCombinedArray = combinedArray.slice(0, 190);
						var splitCombinedArray_2 = combinedArray.slice(190, combinedArray.length);
						encryptRSA(rsaPublicKey_2, splitCombinedArray).then((data) => {
							encryptRSA(rsaPublicKey_2, splitCombinedArray_2).then((data_2) => {
								var combinedArray = new Uint8Array(data.length + data_2.length); // { passA,{ H(passA) }ka-1 }kb
								combinedArray.set(data);
								combinedArray.set(data_2, data.length);
								var message = combinedArray;
								socket.emit('getResponseStep2', message);
							});
						});
					});
				});
			});

			// Step 2: B
			socket.on('step2', function(msg) {
				combinedArray = new Uint8Array(Object.values(msg));
				exportPrivateRSA(rsaPrivateKey).then((exportedRSAKey) => {
					importPrivateRSA_OAEP(exportedRSAKey).then((importedRSAKey) => {
						var splitCombinedArray = combinedArray.slice(0, 256);
						var splitCombinedArray_2 = combinedArray.slice(256, 512);
						decryptRSA(importedRSAKey, splitCombinedArray).then((data) => {
							decryptRSA(importedRSAKey, splitCombinedArray_2).then((data_2) => {
								var combinedArray = new Uint8Array(data.length + data_2.length); // { passA,{ H(passA) }ka-1 }kb
								combinedArray.set(data);
								combinedArray.set(data_2, data.length);
								var message = combinedArray;
								var passA = message.slice(0, 6); // PassA
								var signature = message.slice(6, 262);
								hashSHA(passA).then((hashed) => { // H(PassA)
									exportRSA(rsaPublicKey_2).then((exportedPublicRSAKey) => {
										importRSA_PSS(exportedPublicRSAKey).then((importedPublicRSAKey) => {
											verifyRSA(importedPublicRSAKey, signature, hashed).then((isvalid) => {
												if (isvalid) {
													var passB = window.crypto.getRandomValues(new Uint8Array(6)); // Create random number PassB
													console.log("Pass B");
													console.log(passB);
													var aesKey = new Uint8Array(passA.length + passB.length);
													aesKey.set(passA);
													aesKey.set(passB, passA.length); // PassA||PassB
													console.log("Aes Key:")
													console.log(aesKey);
													hashSHA(aesKey).then((hashed) => { // hash newly created AES Key
														aesKeyHash = hashed; // Kab = H(PassA || PassB)
														console.log("Hashed AES Key:");
														console.log(aesKeyHash);
														step3(passA, passB, aesKeyHash);
													});
												}
											});
										});
									});
								});
							});
						});
					});
				});
			});

			// Step 3: B
			function step3(passA, passB, aesKeyHash) {
				iv = crypto.getRandomValues(new Uint8Array(12));
				importAES(aesKeyHash, iv).then((Kab) => { //Kab key object
					aesKab = Kab;
					encryptAES(Kab, iv, passA).then((encryptedPassA) => { //{PassA}Kab
						var combinedArray = new Uint8Array(passB.length + encryptedPassA.length);
						combinedArray.set(passB);
						combinedArray.set(encryptedPassA, passB.length);
						hashSHA(combinedArray).then((hashed) => { // H(PassB,{PassA}Kab)
							signRSA(rsaPrivateKey, hashed).then((signedHash) => { //{H(PassB,{PassA}Kab)}Kb-1
								var combinedArray = new Uint8Array(passB.length + encryptedPassA.length + signedHash.length);
								combinedArray.set(passB);
								combinedArray.set(encryptedPassA, passB.length);
								combinedArray.set(signedHash, passB.length + encryptedPassA.length);
								var splitCombinedArray = combinedArray.slice(0, 190);
								var splitCombinedArray_2 = combinedArray.slice(190, combinedArray.length);
								exportRSA(rsaPublicKey_2).then((exportedPublicRSAKey) => {
									importRSA_OAEP(exportedPublicRSAKey).then((importedPublicOAEPKey) => {
										encryptRSA(importedPublicOAEPKey, splitCombinedArray).then((encryptedData) => { //{PassB, {PassA}Kab,{H(PassB,{PassA}Kab)}kb-1}Ka
											encryptRSA(importedPublicOAEPKey, splitCombinedArray_2).then((encryptedData_2) => {
												var message = new Uint8Array(iv.length + encryptedData.length + encryptedData_2.length);
												message.set(iv);
												message.set(encryptedData, iv.length);
												message.set(encryptedData_2, (iv.length + encryptedData.length));
												socket.emit('getResponseStep4', message);
											});
										});
									});
								});
							});
						});
					});
				});
			}

			// Step 4: A
			socket.on('step4', function(msg) {
				combinedArray = new Uint8Array(Object.values(msg)); // { passB, {passB}kab , { H(passB, {passA}kab ) }kb-1 }ka
				iv = combinedArray.slice(0, 12);
				exportPrivateRSA(rsaPrivateKey).then((exportedRSAKey) => {
					importPrivateRSA_OAEP(exportedRSAKey).then((importedRSAKey) => {
						var splitCombinedArray = combinedArray.slice(12, 268);
						var splitCombinedArray_2 = combinedArray.slice(268, 524);
						decryptRSA(importedRSAKey, splitCombinedArray).then((data) => {
							decryptRSA(importedRSAKey, splitCombinedArray_2).then((data_2) => {
								var combinedArray = new Uint8Array(data.length + data_2.length); //  passB, {passB}kab , { H(passB, {passA}kab ) }kb-1
								combinedArray.set(data);
								combinedArray.set(data_2, data.length);
								var message = combinedArray;
								var passB = message.slice(0, 6); // PassB
								console.log("Pass B :");
								console.log(passB);
								console.log("Pass A :");
								console.log(passA);
								var encryptedPassA = message.slice(6, 28); // {passB}kab
								var signature = message.slice(28, 284);
								var combinedArray = new Uint8Array(passB.length + encryptedPassA.length);
								combinedArray.set(passB);
								combinedArray.set(encryptedPassA, passB.length);
								hashSHA(combinedArray).then((hashed) => { // H(PassB, {passA}kab )
									exportRSA(rsaPublicKey_2).then((exportedPublicRSAKey) => {
										importRSA_PSS(exportedPublicRSAKey).then((importedPublicRSAKey) => {
											verifyRSA(importedPublicRSAKey, signature, hashed).then((isvalid) => {
												if (isvalid) {
													console.log("Signature is vaild continue:");
													var aesKey = new Uint8Array(passA.length + passB.length);
													aesKey.set(passA);
													aesKey.set(passB, passA.length); // PassA||PassB
													hashSHA(aesKey).then((hashed) => { // hash newly created AES Key
														aesKeyHash = hashed; // Kab = H(PassA || PassB)
														console.log("Hashed AES Key:");
														console.log(aesKeyHash);
														importAES(aesKeyHash, iv).then((Kab) => { //Kab key object
															aesKab = Kab;
															decryptAES(Kab, iv, encryptedPassA).then((newPassA) => { //{PassA}Kab
																console.log("Decrypted PassA");
																console.log(newPassA);
																if (newPassA.sort().join(',') === passA.sort().join(',')) {
																	console.log("Encrption Protocol has run Successfully!");
																	socket.emit('encryptionSuccessful');
																} else {
																	console.log("Protocol failed: PassA's are NOT the same");
																}
															});
														});
													});
												}
											});
										});
									});
								});
							});
						});
					});
				});
			});

		});
	</script>
</body>

</html>
